my %tld2cont =
(
'ac' => 'Africa',
'ad' => 'Europe',
'ae' => 'Asia',
'af' => 'Asia',
'ag' => 'North America',
'ai' => 'North America',
'al' => 'Europe',
'am' => 'Asia',
'ao' => 'Africa',
'aq' => 'Antarctica',
'ar' => 'South America',
'as' => 'Oceania',
'at' => 'Europe',
'au' => 'Oceania',
'aw' => 'North America',
'ax' => 'Europe',
'az' => 'Europe',
'ba' => 'Europe',
'bb' => 'North America',
'bd' => 'Asia',
'be' => 'Europe',
'bf' => 'Africa',
'bg' => 'Europe',
'bh' => 'Asia',
'bi' => 'Africa',
'bj' => 'Africa',
'bl' => 'North America',
'bm' => 'North America',
'bn' => 'Asia',
'bo' => 'South America',
'bq' => 'North America',
'br' => 'South America',
'bs' => 'North America',
'bt' => 'Asia',
'bv' => 'Antarctica',
'bw' => 'Africa',
'by' => 'Europe',
'bz' => 'North America',
'ca' => 'North America',
'cc' => 'Asia',
'cd' => 'Africa',
'cf' => 'Africa',
'cg' => 'Africa',
'ch' => 'Europe',
'ci' => 'Africa',
'ck' => 'Oceania',
'cl' => 'South America',
'cm' => 'Africa',
'cn' => 'Asia',
'co' => 'South America',
'cp' => 'South America',
'cr' => 'North America',
'cu' => 'North America',
'cv' => 'Africa',
'cw' => 'North America',
'cx' => 'Asia',
'cy' => 'Europe',
'cz' => 'Europe',
'de' => 'Europe',
'dg' => 'Asia',
'dj' => 'Africa',
'dk' => 'Europe',
'dm' => 'North America',
'do' => 'North America',
'dz' => 'Africa',
'ea' => 'Africa',
'ec' => 'South America',
'ee' => 'Europe',
'eg' => 'Africa',
'eh' => 'Africa',
'er' => 'Africa',
'es' => 'Europe',
'et' => 'Africa',
'eu' => 'Europe',
'fi' => 'Europe',
'fj' => 'Oceania',
'fk' => 'South America',
'fm' => 'Oceania',
'fo' => 'Europe',
'fr' => 'Europe',
'ga' => 'Africa',
'gb' => 'Europe',
'gd' => 'North America',
'ge' => 'Asia',
'gf' => 'South America',
'gg' => 'Europe',
'gh' => 'Africa',
'gi' => 'Europe',
'gl' => 'North America',
'gm' => 'Africa',
'gn' => 'Africa',
'gp' => 'North America',
'gq' => 'Africa',
'gr' => 'Europe',
'gs' => 'Antarctica',
'gt' => 'North America',
'gu' => 'Oceania',
'gw' => 'Africa',
'gy' => 'South America',
'hk' => 'Asia',
'hm' => 'Oceania',
'hn' => 'North America',
'hr' => 'Europe',
'ht' => 'North America',
'hu' => 'Europe',
'ic' => 'Africa',
'id' => 'Asia',
'ie' => 'Europe',
'il' => 'Asia',
'im' => 'Europe',
'in' => 'Asia',
'io' => 'Africa',
'iq' => 'Asia',
'ir' => 'Asia',
'is' => 'Europe',
'it' => 'Europe',
'je' => 'Europe',
'jm' => 'North America',
'jo' => 'Asia',
'jp' => 'Asia',
'ke' => 'Africa',
'kg' => 'Asia',
'kh' => 'Asia',
'ki' => 'Oceania',
'km' => 'Africa',
'kn' => 'North America',
'kp' => 'Asia',
'kr' => 'Asia',
'kw' => 'Asia',
'ky' => 'North America',
'kz' => 'Asia',
'la' => 'Asia',
'lb' => 'Asia',
'lc' => 'North America',
'li' => 'Europe',
'lk' => 'Asia',
'lr' => 'Africa',
'ls' => 'Africa',
'lt' => 'Europe',
'lu' => 'Europe',
'lv' => 'Europe',
'ly' => 'Africa',
'ma' => 'Africa',
'mc' => 'Europe',
'md' => 'Europe',
'me' => 'Europe',
'mf' => 'North America',
'mg' => 'Africa',
'mh' => 'Oceania',
'mk' => 'Europe',
'ml' => 'Africa',
'mm' => 'Asia',
'mn' => 'Asia',
'mo' => 'Asia',
'mp' => 'Oceania',
'mq' => 'North America',
'mr' => 'Africa',
'ms' => 'North America',
'mt' => 'Europe',
'mu' => 'Africa',
'mv' => 'Asia',
'mw' => 'Africa',
'mx' => 'North America',
'my' => 'Asia',
'mz' => 'Africa',
'na' => 'Africa',
'nc' => 'Oceania',
'ne' => 'Africa',
'nf' => 'Oceania',
'ng' => 'Africa',
'ni' => 'North America',
'nl' => 'Europe',
'no' => 'Europe',
'np' => 'Asia',
'nr' => 'Oceania',
'nu' => 'Oceania',
'nz' => 'Oceania',
'om' => 'Asia',
'pa' => 'North America',
'pe' => 'South America',
'pf' => 'Oceania',
'pg' => 'Oceania',
'ph' => 'Asia',
'pk' => 'Asia',
'pl' => 'Europe',
'pm' => 'North America',
'pn' => 'Oceania',
'pr' => 'North America',
'ps' => 'Asia',
'pt' => 'Europe',
'pw' => 'Oceania',
'py' => 'South America',
'qa' => 'Asia',
're' => 'Africa',
'ro' => 'Europe',
'rs' => 'Europe',
'ru' => 'Europe',
'rw' => 'Africa',
'sa' => 'Asia',
'sb' => 'Oceania',
'sc' => 'Africa',
'sd' => 'Africa',
'se' => 'Europe',
'sg' => 'Asia',
'sh' => 'Africa',
'si' => 'Europe',
'sj' => 'Europe',
'sk' => 'Europe',
'sl' => 'Africa',
'sm' => 'Europe',
'sn' => 'Africa',
'so' => 'Africa',
'sr' => 'South America',
'ss' => 'Africa',
'st' => 'Africa',
'sv' => 'Europe',
'sx' => 'North America',
'sy' => 'Asia',
'sz' => 'Africa',
'ta' => 'Africa',
'tc' => 'Asia',
'td' => 'Africa',
'tf' => 'Africa',
'tg' => 'Africa',
'th' => 'Asia',
'tj' => 'Asia',
'tk' => 'Oceania',
'tl' => 'Asia',
'tm' => 'Asia',
'tn' => 'Africa',
'to' => 'Oceania',
'tr' => 'Asia',
'tt' => 'North America',
'tv' => 'Oceania',
'tw' => 'Asia',
'tz' => 'Africa',
'ua' => 'Europe',
'ug' => 'Africa',
'uk' => 'Europe',
'um' => 'North America',
'un' => 'Earth',
'us' => 'North America',
'uy' => 'South America',
'uz' => 'Asia',
'va' => 'Europe',
'vc' => 'North America',
've' => 'South America',
'vg' => 'North America',
'vi' => 'North America',
'vn' => 'Asia',
'vu' => 'Oceania',
'wf' => 'Oceania',
'ws' => 'Oceania',
'xk' => 'Europe',
'ye' => 'Asia',
'yt' => 'Africa',
'za' => 'Africa',
'zm' => 'Africa',
'zw' => 'Africa',
 );

my %tld2cntr =
(
"ac" => "Ascension Island",
"ad" => "Andorra",
"ae" => "Arab Emirates",
"af" => "Afghanistan",
"ag" => "Antigua",
"ai" => "Anguilla",
"al" => "Albania",
"am" => "Armenia",
"ao" => "Angola",
"aq" => "Antarctica",
"ar" => "Argentina",
"as" => "American Samoa",
"at" => "Austria",
"au" => "Australia",
"aw" => "Aruba",
"ax" => "Åland Islands",
"az" => "Azerbaijan",
"ba" => "Bosnia & Herzegovina",
"bb" => "Barbados",
"bd" => "Bangladesh",
"be" => "Belgium",
"bf" => "Burkina Faso",
"bg" => "Bulgaria",
"bh" => "Bahrain",
"bi" => "Burundi",
"bj" => "Benin",
"bl" => "St. Barthélemy",
"bm" => "Bermuda",
"bn" => "Brunei",
"bo" => "Bolivia",
"bq" => "Caribbean Netherlands",
"br" => "Brazil",
"bs" => "Bahamas",
"bt" => "Bhutan",
"bv" => "Bouvet",
"bw" => "Botswana",
"by" => "Belarus",
"bz" => "Belize",
"ca" => "Canada",
"cc" => "Cocos",
"cd" => "Congo-Kinshasa",
"cf" => "Central African",
"cg" => "Congo",
"ch" => "Switzerland",
"ci" => "Cote D'Ivoire",
"ck" => "Cook",
"cl" => "Chile",
"cm" => "Cameroon",
"cn" => "China",
"co" => "Colombia",
"cp" => "Clipperton Island",
"cr" => "Costa Rica",
"cu" => "Cuba",
"cv" => "Cape Verde",
"cw" => "Curaçao",
"cx" => "Christmas",
"cy" => "Cyprus",
"cz" => "Czech",
"de" => "Germany",
"dg" => "Diego Garcia",
"dj" => "Djibouti",
"dk" => "Denmark",
"dm" => "Dominica",
"do" => "Dominican Republic",
"dz" => "Algeria",
"ea" => "Ceuta & Melilla",
"ec" => "Ecuador",
"ee" => "Estonia",
"eg" => "Egypt",
"eh" => "Western Sahara",
"er" => "Eritrea",
"es" => "Spain",
"et" => "Ethiopia",
"eu" => "European Union",
"fi" => "Finland",
"fj" => "Fiji",
"fk" => "Falkland",
"fm" => "Micronesia",
"fo" => "Faroe",
"fr" => "France",
"ga" => "Gabon",
"gb" => "Great Britain",
"gd" => "Grenada",
"ge" => "Georgia",
"gf" => "Guiana",
"gg" => "Guernsey",
"gh" => "Ghana",
"gi" => "Gibraltar",
"gl" => "Greenland",
"gm" => "Gambia",
"gn" => "Guinea",
"gp" => "Guadeloupe",
"gq" => "Equatorial Guinea",
"gr" => "Greece",
"gs" => "South Georgia & South Sandwich Islands",
"gt" => "Guatemala",
"gu" => "Guam",
"gw" => "Guinea-Bissau",
"gy" => "Guyana",
"hk" => "Hong Kong",
"hm" => "Heard, Mc Donald",
"hn" => "Honduras",
"hr" => "Croatia",
"ht" => "Haiti",
"hu" => "Hungary",
"ic" => "Canary Islands",
"id" => "Indonesia",
"ie" => "Ireland",
"il" => "Israel",
"im" => "Isle of Man",
"in" => "India",
"io" => "Indian Ocean",
"iq" => "Iraq",
"ir" => "Iran",
"is" => "Iceland",
"it" => "Italy",
"je" => "Jersey",
"jm" => "Jamaica",
"jo" => "Jordan",
"jp" => "Japan",
"ke" => "Kenya",
"kg" => "Kyrgyzstan",
"kh" => "Cambodia",
"ki" => "Kiribati",
"km" => "Comoros",
"kn" => "Saint Kitts",
"kp" => "North Korea",
"kr" => "South Korea",
"kw" => "Kuwait",
"ky" => "Cayman",
"kz" => "Kazakhstan",
"la" => "Lao",
"lb" => "Lebanon",
"lc" => "Saint Lucia",
"li" => "Liechtenstein",
"lk" => "Sri Lanka",
"lr" => "Liberia",
"ls" => "Lesotho",
"lt" => "Lithuania",
"lu" => "Luxembourg",
"lv" => "Latvia",
"ly" => "Libyan",
"ma" => "Morocco",
"mc" => "Monaco",
"md" => "Moldova",
"me" => "Montenegro",
"mf" => "St. Martin",
"mg" => "Madagascar",
"mh" => "Marshall",
"mk" => "Macedonia",
"ml" => "Mali",
"mm" => "Myanmar",
"mn" => "Mongolia",
"mo" => "Macau",
"mp" => "Mariana",
"mq" => "Martinique",
"mr" => "Mauritania",
"ms" => "Montserrat",
"mt" => "Malta",
"mu" => "Mauritius",
"mv" => "Maldives",
"mw" => "Malawi",
"mx" => "Mexico",
"my" => "Malaysia",
"mz" => "Mozambique",
"na" => "Namibia",
"nc" => "New Caledonia",
"ne" => "Niger",
"nf" => "Norfolk",
"ng" => "Nigeria",
"ni" => "Nicaragua",
"nl" => "Netherlands",
"no" => "Norway",
"np" => "Nepal",
"nr" => "Nauru",
"nu" => "Niue",
"nz" => "New Zealand",
"om" => "Oman",
"pa" => "Panama",
"pe" => "Peru",
"pf" => "French Polynesia",
"pg" => "Papua",
"ph" => "Philippines",
"pk" => "Pakistan",
"pl" => "Poland",
"pm" => "St. Pierre, Miquelon",
"pn" => "Pitcairn",
"pr" => "Puerto Rico",
"ps" => "Palestinian Territories",
"pt" => "Portugal",
"pw" => "Palau",
"py" => "Paraguay",
"qa" => "Qatar",
"re" => "Reunion",
"ro" => "Romania",
"rs" => "Serbia",
"ru" => "Russia",
"rw" => "Rwanda",
"sa" => "Saudi Arabia",
"sb" => "Solomon",
"sc" => "Seychelles",
"sd" => "Sudan",
"se" => "Sweden",
"sg" => "Singapore",
"sh" => "St. Helena",
"si" => "Slovenia",
"sj" => "Svalbard",
"sk" => "Slovakia",
"sl" => "Sierra Leone",
"sm" => "San Marino",
"sn" => "Senegal",
"so" => "Somalia",
"sr" => "Suriname",
"ss" => "South Sudan",
"st" => "Sao Tome, Principe",
"sv" => "El Salvador",
"sx" => "Sint Maarten",
"sy" => "Syria",
"sz" => "Swaziland",
"ta" => "Tristan da Cunha",
"tc" => "Turks, Caicos",
"td" => "Chad",
"tf" => "Southern",
"tg" => "Togo",
"th" => "Thailand",
"tj" => "Tajikistan",
"tk" => "Tokelau",
"tl" => "Timor-Leste",
"tm" => "Turkmenistan",
"tn" => "Tunisia",
"to" => "Tonga",
"tr" => "Turkey",
"tt" => "Trinidad",
"tv" => "Tuvalu",
"tw" => "Taiwan",
"tz" => "Tanzania",
"ua" => "Ukraine",
"ug" => "Uganda",
"uk" => "United Kingdom",
"um" => "Minor Outlying",
"un" => "United Nations",
"us" => "United States",
"uy" => "Uruguay",
"uz" => "Uzbekistan",
"va" => "Vatican",
"vc" => "Saint Vincent, Grenadines",
"ve" => "Venezuela",
"vg" => "British Virgin",
"vi" => "US Virgin",
"vn" => "Vietnam",
"vu" => "Vanuatu",
"wf" => "Wallis and Futuna Islands",
"ws" => "Samoa",
"xk" => "Kosovo",
"ye" => "Yemen",
"yt" => "Mayotte",
"za" => "South Africa",
"zm" => "Zambia",
"zw" => "Zimbabwe",
 );

# Use ipwhere to do IP geolocation lookup
sub mycountry_ipwhere {
    my ($ip)=@_;
    my @o=`/home/dast/bin/ipwhere $ip`;
    my ($tld, $area, $full);
    for(@o) {
        if($_ =~ /^TLD: (.*)/) {
            $tld = $1;
        }
        elsif($_ =~ /^AREA: (.*)/) {
            $area = $1;
        }
        elsif($_ =~ /^FULL: (.*)/) {
            $full = $1;
        }
    }

    return ($tld, $area, $full);
}

# Use geoip to do IP geolocation lookup
sub mycountry {
    my ($ip)=@_;
    my @o;
    if($ip =~ /:/) {
      @o=`/usr/bin/geoiplookup6 $ip`;
    } else {
      @o=`/usr/bin/geoiplookup $ip`;
    }
    $o[0] =~ /^.*: ([^,]*), ([^,]*?)\s*$/;
    my ($tld,$ctry) = ($1,$2);
    $tld = "UK" if ($tld eq "GB");  # TLD is uk, not gb
    return ($tld, tld2continent($tld), $ctry);
}

# convert a two-letter TLD to a full text continent string
sub tld2continent {
    my ($tld)=@_;

    return $tld2cont{lc($tld)};
}

# convert a two-letter TLD to a full text country string
sub tld2country {
    my ($tld)=@_;

    return $tld2cntr{lc($tld)};
}

# convert an exact country string into a two-letter TLD
sub country2tld {
    my ($cntr)=@_;

    if ($cntr =~ /^Great Britain/) {
        return "uk";    # TLD is uk, not gb
    }

    for (keys(%tld2cntr)) {
        if ($cntr =~ /^$tld2cntr{$_}/) {
            return $_;
        }
    }

    # This is a pretty vague regex, so match it only as a last resort
    if ($cntr =~ /US/) {
        return "us";
    }
    return "";
}

1;
